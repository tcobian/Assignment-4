---
title: 'Assignment 4'
author: "Tyler Cobian, Sara Orofino, Alex Ivina"
date: "November 8, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(knitr)
library(plotly)
install.packages("vcdExtra")
library(vcdExtra)
library(car)
library(onewaytests)
library(kableExtra)
library(xtable)
library(multcompView)
lobster_size_abundance<-read_csv("lobster_size_abundance.csv")
lobster_traps<- read_csv("lobster_traps (1).csv")

#read in tidyverse and knitr packeges (what other packages do you think we will need?)
#load data for lobster size and abundance and name it "lobster_size_abundance" 
#load data for lobster fishing pressure and name it "lobster_traps"

```

##1. Lobster abundance and fishing pressure
```{r}
#basic data wrangling
lobster_traps_1<-lobster_traps %>% 
  select(YEAR,SITE,TRAPS) %>% 
  filter(SITE == "AQUE" | SITE == "CARP" | SITE == "IVEE" | SITE == "MOHK" | SITE == "NAPL")

#just keep Year Site and Trap data

lobster_1<- lobster_size_abundance %>% 
  filter(SIZE != -99999) %>% 
  select(SITE,YEAR,MONTH,SIZE,COUNT) 
#took out the -99999 values out of lobster_size_abundance under size because this means it was not recorded
#Only kept Year, Month, Size and Count data
  
lobster_1$MONTH<- (month.abb[lobster_1$MONTH])
#change numerical months in "lobster_1" to three letter abbreviation

lobster_traps$MONTH<- (month.abb[lobster_traps$MONTH])
#change numerical months in "lobster_traps" to three letter abbreviation
```


```{r}
#graph for each site relating count to year
abundance_graph<-ggplot(lobster_1, aes(x = YEAR, y = COUNT))+
  geom_point(aes(color = COUNT), show.legend = "false", alpha = 0.5)+
  facet_wrap(~SITE, scales = "free")+
  scale_y_continuous(name = "number of lobsters", limits = c(0,25))+
  theme_classic()
abundance_graph
ggplotly(abundance_graph)


#graph relating fishing pressure (number of traps) for each site by year

pressure_graph<- ggplot(lobster_traps_1, aes(x = YEAR, y = TRAPS))+
  geom_point(aes(color = TRAPS), show.legend = "false", alpha = 0.5)+
  facet_wrap(~SITE, scales = "free")+
  scale_y_continuous(name = "number of traps", limits = c(0,25))+
  theme_classic()
pressure_graph
ggplotly(pressure_graph)

```


2. Compare mean lobster size by site in 2017

```{r}
#Use lobster_1 df for mean size data
# Test for equal variance (levenes) and run an ANOVA
# maybe a posthoc test

lobster_2<- lobster_1 %>% 
  as.data.frame() %>%
  expand.dft(freq = "COUNT") 

lobster_2

#Do an Levene test to see if variances are equal
lobster_levene<- leveneTest(SIZE ~ SITE, data = lobster_2)
lobster_levene

#The variances are not equal. Look at actual variances to determine if ANOVA can still be used. 

variance<- lobster_2 %>% 
  group_by(SITE) %>% 
  summarize(variance = var(SIZE))
variance

# This shows that the lowest variance is less than 4  times smaller than the largest variance, so we can use a one way ANOVA

# Run ANOVA to test for differences in means across groups
# HO: Means across all sites are equal
#HA: At least two means are not equal

lobster_ANOVA <- aov(SIZE ~SITE, data = lobster_2)
summary(lobster_ANOVA)

# reject null hypothesis, at least two samples are from sites with different means

# Use Tukeyhsd to find out which means are different

lobster_hsd<- TukeyHSD(lobster_ANOVA)
lobster_hsd
plot(lobster_hsd , las=1 , col="brown" )
# CARP and AQUE are not different
# IVEE and AQUE are not different
# IVEE and CARP are not different

# create a graphic to show differences in means

#finding sd to put in error bars in graph
site_summary<- lobster_2 %>% 
  group_by(SITE) %>% 
  summarize(sd = sd(SIZE),
            mean = mean(SIZE))
site_summary

lobster_box<- ggplot(lobster_2, aes(x = SITE, y = SIZE))+
  geom_boxplot()
lobster_box

# Experimental Code to get the letters above the graph..... 
generate_label_df <- function(TUKEY, variable){
  Tukey.levels <- TUKEY[[variable]][,4]
  Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
  Tukey.labels$SITE=rownames(Tukey.labels)
  Tukey.labels=Tukey.labels[order(Tukey.labels$SITE) , ]
  return(Tukey.labels)
}
LABEL=generate_label_df(TUKEY , "SITE")
my_colors=c( rgb(143,199,74,maxColorValue = 255),rgb(242,104,34,maxColorValue = 255), rgb(111,145,202,maxColorValue = 255),rgb(254,188,18,maxColorValue = 255) , rgb(74,132,54,maxColorValue = 255),rgb(236,33,39,maxColorValue = 255),rgb(165,103,40,maxColorValue = 255))

experiment = boxplot(lobster_2$SIZE ~ lobster_2$SITE, ylim=c(min(lobster_2$SIZE) , 1.1*max(lobster_2$SIZE)) , col=my_colors[as.numeric(LABEL[ , 1])] , ylab="Lobster Size" , main="Site")

# ask in office hours why ANOVA and Tukey says means are different but graph of means by site looks similar

```


3. Changes in lobster size at MPA and non MPA sites (comparing only 2012 and 2017 sizes)

```{r}
# create a data fram for only 2012 ann 2017
lobster_3<- lobster_2 %>% 
  filter(YEAR == 2012 | YEAR == 2017)
lobster_3

mpa<- lobster_3 %>% 
  filter(SITE == "IVEE" | SITE == "NAPL")

mpa_IVEE<- mpa %>% 
  filter(SITE == "IVEE") %>% 
  spread(SIZE,YEAR)
mpa_IVEE


# I was able to perform a t.test for the two mpa sites between year 2012 and 2017, I dont know if this is what we need Gage had said something about doing 5 seperate t.tests for each site between the two years

mpa_testt<- mpa %>% 
  t.test(SIZE~YEAR, data = . , var.equal = TRUE)
mpa_testt

# p-value = 0.056 so means do not differ significantly between the two years.

```


4. Proportions of "legal" lobsters at the 5 sites in 2017

```{r}
lobster_4<- lobster_2 %>% 
  count(SITE,SIZE) %>% 
  spread(SIZE,n)
# we need to try and make a df that has eaxh site and the amount of lobsters above and below th elegal limit

legal_counts<- lobster_2 %>% 
  mutate(legal = case_when(SIZE>=82.6 ~ "yes", SIZE<82.6 ~ "no")) %>% 
  count(SITE,legal) %>% 
  spread(legal,n) %>% 
  select(-SITE)
rownames(legal_counts)<-c("AQUE","CARP","IVEE","MOHK","NAPL")
legal_counts

#make a kable table for the legal_counts data

legal_counts_table<-kable(legal_counts,
      caption = "Amount of lobsters over legal size 82.6mm at each site") %>% 
  kable_styling(c("striped", "border"))
legal_counts_table
# perform a chi-square to test for independance

legal_prop<- prop.table(as.matrix(legal_counts), 1)
legal_prop

legal_prop_table<- kable(legal_prop, 
                         caption = "Proportion of lobsters that are over legal size at each site") %>% 
  kable_styling(c("striped", "border"))
legal_prop_table


# perform a chi-square to see if there is an association between site and size of lobster
# results tell us there is p - value is close to zero
lobster_x2<- chisq.test(legal_counts)
lobster_x2








```















