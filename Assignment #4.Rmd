---
title: 'Assignment 4'
author: "Tyler Cobian, Sara Orofino, Alex Ivina"
date: "November 8, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(knitr)
library(plotly)
install.packages("vcdExtra")
library(vcdExtra)
library(car)
library(onewaytests)
library(kableExtra)
library(xtable)
library(multcompView)
library(RColorBrewer)
lobster_size_abundance<-read_csv("lobster_size_abundance.csv")
lobster_traps<- read_csv("lobster_traps (1).csv")

#read in tidyverse and knitr packeges (what other packages do you think we will need?)
#load data for lobster size and abundance and name it "lobster_size_abundance" 
#load data for lobster fishing pressure and name it "lobster_traps"

```

##1. Lobster abundance and fishing pressure
```{r}
#basic data wrangling
lobster_traps_1<-lobster_traps %>% 
  select(YEAR,SITE,TRAPS) %>% 
  filter(SITE == "AQUE" | SITE == "CARP" | SITE == "IVEE" | SITE == "MOHK" | SITE == "NAPL")

#just keep Year Site and Trap data

lobster_1<- lobster_size_abundance %>% 
  filter(SIZE != -99999) %>% 
  select(SITE,YEAR,MONTH,SIZE,COUNT) 
#took out the -99999 values out of lobster_size_abundance under size because this means it was not recorded
#Only kept Year, Month, Size and Count data
  
lobster_1$MONTH<- (month.abb[lobster_1$MONTH])
#change numerical months in "lobster_1" to three letter abbreviation

lobster_traps$MONTH<- (month.abb[lobster_traps$MONTH])
#change numerical months in "lobster_traps" to three letter abbreviation
```


```{r}
#graph for each site relating count to year
abundance_graph<-ggplot(lobster_1, aes(x = YEAR, y = COUNT))+
  geom_point(aes(color = COUNT), show.legend = "false", alpha = 0.5)+
  facet_wrap(~SITE, scales = "free")+
  scale_y_continuous(name = "number of lobsters", limits = c(0,25))+
  theme_classic()
abundance_graph
ggplotly(abundance_graph)


#graph relating fishing pressure (number of traps) for each site by year

pressure_graph<- ggplot(lobster_traps_1, aes(x = YEAR, y = TRAPS))+
  geom_point(aes(color = TRAPS), show.legend = "false", alpha = 0.5)+
  facet_wrap(~SITE, scales = "free")+
  scale_y_continuous(name = "number of traps", limits = c(0,25))+
  theme_classic()
pressure_graph
ggplotly(pressure_graph)

```


2. Compare mean lobster size by site in 2017

```{r}
#Use lobster_1 df for mean size data
# Test for equal variance (levenes) and run an ANOVA
# maybe a posthoc test

lobster_2<- lobster_1 %>% 
  as.data.frame() %>%
  expand.dft(freq = "COUNT") 

lobster_2

#Do an Levene test to see if variances are equal
lobster_levene<- leveneTest(SIZE ~ SITE, data = lobster_2)
lobster_levene

#The variances are not equal. Look at actual variances to determine if ANOVA can still be used. 

<<<<<<< HEAD
variance<- lobster_2 %>% 
  group_by(SITE) %>% 
  summarize(variance = var(SIZE))
variance

# This shows that the lowest variance is less than 4  times smaller than the largest variance, so we can use a one way ANOVA
=======
# Run ANOVA to see if means are equal
class(lobster_2$SIZE)
unique(lobster_2$SITE)

lobster_ANOVA<- aov(SITE ~ SIZE, data = lobster_2) 
lobster_ANOVA
>>>>>>> 25c387cea9908cda74feae8a1f021543ef97be44

# Run ANOVA to test for differences in means across groups
# HO: Means across all sites are equal
#HA: At least two means are not equal

lobster_ANOVA <- aov(SIZE ~SITE, data = lobster_2)
summary(lobster_ANOVA)

# reject null hypothesis, at least two samples are from sites with different means

# Use Tukeyhsd to find out which means are different

lobster_hsd<- TukeyHSD(lobster_ANOVA)
lobster_hsd
plot(lobster_hsd , las=1 , col="brown" )
# CARP and AQUE are not different
# IVEE and AQUE are not different
# IVEE and CARP are not different

# create a graphic to show differences in means

#finding mean and sd to put in error bars in graph
site_summary<- lobster_2 %>% 
  group_by(SITE) %>% 
  summarize(sd = sd(SIZE),
            mean = mean(SIZE))
site_summary

<<<<<<< HEAD
# This column graph has letters above for sites that DID NOT differ signficantly. Not sure if this is the right way to do this though. 

lobster_col <- ggplot(site_summary, aes(x = SITE, y = mean)) +
  geom_col(colour = NA, fill = "snow3", width = 0.6) +
  geom_errorbar(aes(ymin =mean - sd, ymax = mean + sd), color = "gray0", width = .3) +
  scale_y_continuous(expand = c(0,0), limits = c(0,100)) +
  scale_x_discrete(labels = c("Arroyo Quemado","Carpinteria","Isla Vista","Mohawk Reef","Naples Reef")) +
  annotate("text", x = 1, y = 89, label = "a", family = "Times New Roman") +
  annotate("text", x = 2, y = 89, label = "a", family = "Times New Roman") +
  annotate("text", x = 3, y = 90, label = "a", family = "Times New Roman") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(family = "Times New Roman"))+
  xlab("\n Long-Term Ecological Research Site")+
  ylab("Mean Lobster Carapace Length (mm)")
lobster_col

# Boxplot with letters above the ones that DID NOT differ significantly. 

lobster_box <- ggplot(lobster_2, aes(x = SITE, y = SIZE))+
  geom_boxplot()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(family = "Times New Roman"))+
  xlab("\n Long-Term Ecological Research Site")+
  ylab("Mean Lobster Carapace Length (mm)") +
  scale_y_continuous(expand = c(0,0), limits = c(0,175)) +
  scale_x_discrete(labels = c("Arroyo Quemado","Carpinteria","Isla Vista","Mohawk Reef","Naples Reef")) +
  annotate("text", x = 1, y = 115, label = "a", family = "Times New Roman") +
  annotate("text", x = 2, y = 170, label = "a", family = "Times New Roman") +
  annotate("text", x = 3, y = 160, label = "a", family = "Times New Roman")

lobster_box

# I don't know about the boxplot guys it looks kind of weird with the numbers above it but at the same time I think boxplot looks better than the graph in terms of actually representing the data. I can try and find out how to put the p-values on it instead. 
=======
lobster_bar<- ggplot(lobster_2, aes(x = SITE, y = SIZE))+
  geom_col()+
  geom_errorbar(aes(ymin = mean-sd, ymax = sd+sd))
lobster_bar
# ask in office hours why ANOVA and Tukey says means are different but graph of means by site looks similar
>>>>>>> 25c387cea9908cda74feae8a1f021543ef97be44

```


3. Changes in lobster size at MPA and non MPA sites (comparing only 2012 and 2017 sizes)

```{r}
# create a data fram for only 2012 ann 2017
# at the end create a bar or col graph comparing 2017 and 2012 values at each site
lobster_3<- lobster_2 %>% 
  filter(YEAR == 2012 | YEAR == 2017)
lobster_3

mpa<- lobster_3 %>% 
  filter(SITE == "IVEE" | SITE == "NAPL")

############# Tests for IVEE
mpa_IVEE<- mpa %>% 
  filter(SITE == "IVEE") 
mpa_IVEE


IVEE_test<- mpa_IVEE %>% 
  t.test(SIZE~YEAR, data = .)
IVEE_test

############ Tests for NAPL








# I was able to perform a t.test for the two mpa sites between year 2012 and 2017, I dont know if this is what we need Gage had said something about doing 5 seperate t.tests for each site between the two years

mpa_testt<- mpa %>% 
  t.test(SIZE~YEAR, data = . , var.equal = TRUE)
mpa_testt

# p-value = 0.056 so means do not differ significantly between the two years.

```


4. Proportions of "legal" lobsters at the 5 sites in 2017

```{r}
lobster_4<- lobster_2 %>% 
  count(SITE,SIZE) %>% 
  spread(SIZE,n)
# we need to try and make a df that has eaxh site and the amount of lobsters above and below th elegal limit

legal_counts<- lobster_2 %>% 
  mutate(legal = case_when(SIZE>=82.6 ~ "yes", SIZE<82.6 ~ "no")) %>% 
  count(SITE,legal) %>% 
  spread(legal,n) %>% 
  select(-SITE)
rownames(legal_counts)<-c("AQUE","CARP","IVEE","MOHK","NAPL")
legal_counts

#make a kable table for the legal_counts data

legal_counts_table<-kable(legal_counts,
      caption = "Amount of lobsters over legal size 82.6mm at each site") %>% 
  kable_styling(c("striped", "border"))
legal_counts_table
# perform a chi-square to test for independance

legal_prop<- prop.table(as.matrix(legal_counts), 1)
legal_prop

legal_prop_table<- kable(legal_prop, 
                         caption = "Proportion of lobsters that are over legal size at each site") %>% 
  kable_styling(c("striped", "border"))
legal_prop_table


# perform a chi-square to see if there is an association between site and size of lobster
# results tell us there is p - value is close to zero
lobster_x2<- chisq.test(legal_counts)
lobster_x2








```















